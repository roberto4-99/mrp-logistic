<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MRP Logistic | Tasks</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0f172a,#111827);
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
    }
    :root{
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.18);
      --accentA:#22c55e;
      --accentB:#3b82f6;
      --accentC:#a78bfa; /* purple */
      --accentD:#7dd3fc; /* sky */
      --dark:#020617;
    }

    .toast{
      position:fixed;left:16px;bottom:90px;
      background:#020617;
      border:1px solid rgba(255,255,255,.14);
      padding:12px 14px;border-radius:14px;
      display:none;z-index:9999;max-width:360px;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
    }
    .toast.show{display:block}

    .wrap{max-width:1100px;margin:auto;padding:20px;padding-bottom:120px}

    /* Header */
    .header{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      margin-bottom:18px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:54px;height:54px;border-radius:18px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .title{font-size:18px;font-weight:900}
    .sub{font-size:12px;opacity:.8}

    .btn-link{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.2);
      padding:10px 14px;border-radius:999px;
      color:#fff;text-decoration:none;font-weight:800;
      white-space:nowrap;
      transition:transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .btn-link:hover{
      background:rgba(255,255,255,.16);
      border-color:rgba(255,255,255,.28);
      transform:translateY(-1px);
    }
    .btn-link:active{transform:translateY(1px) scale(.99)}

    .grid{display:grid;gap:14px}

    .card{
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:22px;
      padding:16px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 55px rgba(0,0,0,.25);
    }

    .topRow{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:999px;
      font-size:12px;font-weight:900;
    }

    /* Tasks */
    .task{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
    }
    .left{
      display:flex;align-items:center;gap:12px;
      min-width:0;
    }
    .meta{min-width:0}
    .meta b{display:block}
    .meta .small{
      font-size:12px;opacity:.8;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:560px
    }
    @media(max-width:700px){
      .meta .small{max-width:240px}
    }

    .dot{
      width:12px;height:12px;border-radius:50%;
      box-shadow:0 0 0 6px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .dot.ok{background:#22c55e}
    .dot.wait{background:#f59e0b}
    .dot.lock{background:#64748b}

    .btn{
      border:none;cursor:pointer;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      background:#111;color:#fff;
      white-space:nowrap;
      transition:transform .12s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    /* Nav (interactive like home) */
    .nav{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.65);
      border-top:1px solid rgba(255,255,255,.14);
      backdrop-filter:blur(12px);
      z-index:999;
    }
    .nav .inner{
      max-width:1100px;margin:auto;
      display:flex;justify-content:space-around;align-items:center;
      padding:10px;
      gap:10px;
    }
    .navbtn{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:4px;
      min-width:90px;
      padding:10px 12px;
      border-radius:16px;
      color:#fff;
      text-decoration:none;
      font-weight:900;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      cursor:pointer;
      transition:transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .navbtn .ico{font-size:20px;line-height:1}
    .navbtn .txt{font-size:11px;opacity:.9}
    .navbtn:hover{
      background:rgba(255,255,255,.16);
      border-color:rgba(255,255,255,.28);
      transform:translateY(-1px);
    }
    .navbtn:active{transform:translateY(1px) scale(.98)}
    .navbtn.active{
      background:linear-gradient(135deg,var(--accentA),var(--accentB));
      border-color:transparent;
      box-shadow:0 10px 26px rgba(0,0,0,.25);
      color:#020617;
    }
    .navbtn.active .txt{opacity:1}
    .navbtn.danger{
      background:rgba(239,68,68,.20);
      border-color:rgba(239,68,68,.35);
    }
    .navbtn.danger:hover{
      background:rgba(239,68,68,.28);
      border-color:rgba(239,68,68,.5);
    }
    .nav form{margin:0}

    /* =========  âœ¨ SMART TASK OVERLAY (NEW) ========= */
    .overlay{
      position:fixed; inset:0;
      display:none;
      z-index:3000;
      background:radial-gradient(900px 600px at 50% 45%, rgba(2,6,23,.35), rgba(2,6,23,.78));
      backdrop-filter: blur(10px);
    }
    .overlay.show{display:block}
    .center{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .halo{
      position:relative;
      width:min(320px, 86vw);
      height:min(320px, 86vw);
      border-radius:999px;
      display:grid;
      place-items:center;
      transform: translateZ(0);
    }

    /* glow layers */
    .halo::before{
      content:"";
      position:absolute; inset:-18px;
      border-radius:999px;
      background:
        radial-gradient(circle at 35% 30%, rgba(125,211,252,.45), transparent 55%),
        radial-gradient(circle at 60% 70%, rgba(167,139,250,.38), transparent 60%),
        radial-gradient(circle at 50% 50%, rgba(34,197,94,.20), transparent 70%);
      filter: blur(10px);
      animation: pulse 1.6s ease-in-out infinite;
      opacity:.95;
    }
    .halo::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }

    @keyframes pulse{
      0%,100%{ transform:scale(0.98); opacity:.85 }
      50%{ transform:scale(1.02); opacity:1 }
    }

    /* progress ring */
    .ring{
      position:relative;
      width:78%;
      height:78%;
      z-index:2;
      display:grid;
      place-items:center;
    }
    svg{display:block}
    .ring svg{
      width:100%;
      height:100%;
      transform: rotate(-90deg);
      filter: drop-shadow(0 16px 30px rgba(0,0,0,.35));
    }
    .ringTrack{
      stroke: rgba(255,255,255,.10);
      stroke-width:10;
      fill:none;
    }
    .ringProg{
      stroke: url(#grad);
      stroke-width:10;
      fill:none;
      stroke-linecap: round;
      stroke-dasharray: 999;
      stroke-dashoffset: 999;
      transition: stroke-dashoffset .18s ease-in-out;
    }

    /* subtle shimmer vibration */
    .vibe{
      position:absolute; inset:0;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      animation: vibe 1.2s ease-in-out infinite;
      z-index:2;
      pointer-events:none;
    }
    @keyframes vibe{
      0%,100%{ transform: translate(0,0); opacity:.55 }
      50%{ transform: translate(1px,-1px); opacity:.8 }
    }

    .count{
      position:absolute;
      z-index:3;
      text-align:center;
      width:70%;
      pointer-events:none;
    }
    .count .big{
      font-weight:1000;
      font-size:40px;
      letter-spacing:.5px;
      margin:0;
      line-height:1.05;
      background: linear-gradient(135deg, var(--accentD), var(--accentC));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .count .small{
      margin-top:8px;
      font-size:12px;
      opacity:.86;
      line-height:1.5;
    }

    .taskTitle{
      margin-top:10px;
      font-weight:900;
      font-size:13px;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* particles canvas */
    #fx{
      position:fixed; inset:0;
      width:100%; height:100%;
      z-index:3100;
      pointer-events:none;
      display:none;
    }
    #fx.show{display:block}

    /* completion flash */
    .flash{
      position:fixed; inset:0;
      background: radial-gradient(700px 400px at 50% 45%, rgba(125,211,252,.40), rgba(167,139,250,.18), transparent 65%),
                  rgba(255,255,255,.02);
      opacity:0;
      z-index:3200;
      pointer-events:none;
    }
    .flash.go{
      animation: flash .45s ease-in-out;
    }
    @keyframes flash{
      0%{opacity:0}
      35%{opacity:.95}
      100%{opacity:0}
    }

    /* checkmark draw */
    .checkWrap{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      z-index:4;
      opacity:0;
      transform: scale(.92);
      pointer-events:none;
    }
    .checkWrap.show{
      opacity:1;
      transform: scale(1);
      transition: opacity .18s ease, transform .18s ease;
    }
    .checkSvg{
      width:120px;height:120px;
      filter: drop-shadow(0 20px 40px rgba(0,0,0,.35));
    }
    .checkCircle{
      stroke: rgba(255,215,0,.25);
      stroke-width:6;
      fill:none;
    }
    .checkPath{
      stroke: #facc15; /* gold */
      stroke-width:10;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      stroke-dasharray: 120;
      stroke-dashoffset: 120;
      animation: draw .55s ease-in-out forwards;
    }
    @keyframes draw{
      to{ stroke-dashoffset: 0; }
    }

    /* small hint button */
    .cancelBtn{
      position:absolute;
      bottom:-54px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:not-allowed;
      opacity:.55;
      white-space:nowrap;
      z-index:2;
    }
    .cancelBtn small{opacity:.85;font-weight:700}

  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="wrap">

  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="logo">
        <img
          src="https://reduced-maroon-xf3kajtb8g.edgeone.app/WhatsApp%20Image%202026-02-28%20at%2012.54.14.jpeg"
          alt="MRP Logo"
        />
      </div>
      <div>
        <div class="title">MRP Logistic</div>
        <div class="sub">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
      </div>
    </div>
    <a class="btn-link" href="/home">â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  </div>

  <div class="card">
    <div class="topRow">
      <div>
        <div class="title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</div>
        <div class="sub">Ø£ÙƒÙ…Ù„ Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© (Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</div>
      </div>
      <div class="pill" id="waitPill">â±ï¸ Ø§Ù†ØªØ¸Ø§Ø± 10 Ø«ÙˆØ§Ù†ÙŠ Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø©</div>
    </div>

    <div style="height:14px"></div>
    <div id="tasks" class="grid"></div>
  </div>

</div>

<div class="nav">
  <div class="inner">

    <a href="/home" class="navbtn" id="navHome">
      <span class="ico">ğŸ </span>
      <span class="txt">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>

    <a href="/tasks" class="navbtn" id="navTasks">
      <span class="ico">âœ…</span>
      <span class="txt">Ø§Ù„Ù…Ù‡Ø§Ù…</span>
    </a>

    <a href="/profile" class="navbtn" id="navProfile">
      <span class="ico">ğŸ‘¤</span>
      <span class="txt">Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span>
    </a>

    <form method="post" action="/logout">
      <button type="submit" class="navbtn danger">
        <span class="ico">ğŸšª</span>
        <span class="txt">Ø®Ø±ÙˆØ¬</span>
      </button>
    </form>

  </div>
</div>

<!-- âœ¨ FX Canvas -->
<canvas id="fx"></canvas>
<div class="flash" id="flash"></div>

<!-- âœ¨ Smart Overlay -->
<div class="overlay" id="overlay" aria-hidden="true">
  <div class="center">
    <div class="halo" id="halo">
      <div class="ring">
        <svg viewBox="0 0 120 120">
          <defs>
            <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#7dd3fc"/>
              <stop offset="55%" stop-color="#a78bfa"/>
              <stop offset="100%" stop-color="#3b82f6"/>
            </linearGradient>
          </defs>
          <circle class="ringTrack" cx="60" cy="60" r="46"></circle>
          <circle class="ringProg" id="ringProg" cx="60" cy="60" r="46"></circle>
        </svg>

        <div class="vibe"></div>

        <div class="count">
          <div class="big" id="sec">10</div>
          <div class="small" id="hint">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒÙŠØ©â€¦</div>
          <div class="taskTitle" id="runTitle">â€”</div>
        </div>

        <div class="checkWrap" id="checkWrap">
          <svg class="checkSvg" viewBox="0 0 120 120">
            <circle class="checkCircle" cx="60" cy="60" r="46"></circle>
            <path class="checkPath" d="M34 64 L54 82 L90 40"></path>
          </svg>
        </div>
      </div>

      <div class="cancelBtn">â³ Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ù†ØªØ¸Ø±â€¦ <small>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</small></div>
    </div>
  </div>
</div>

<script src="/public/app.js"></script>
<script>
  let currentRun = null;
  let timer = null;
  let waitTotal = 10;
  let waitLeft = 0;

  // FX canvas
  const fx = document.getElementById("fx");
  const ctx = fx.getContext("2d");
  let W=0,H=0, dpr=1;

  function resizeFX(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = fx.width = Math.floor(window.innerWidth * dpr);
    H = fx.height = Math.floor(window.innerHeight * dpr);
    fx.style.width = window.innerWidth + "px";
    fx.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resizeFX);
  resizeFX();

  function toast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2600);
  }

  function statusLabel(status){
    if(status==="completed") return { text:"Ù…ÙƒØªÙ…Ù„Ø©", cls:"ok" };
    if(status==="available") return { text:"Ù…ØªØ§Ø­Ø©", cls:"wait" };
    return { text:"Ù…Ù‚ÙÙ„Ø©", cls:"lock" };
  }

  function renderTask(t){
    const st = statusLabel(t.status);
    const btn = t.status==="available"
      ? `<button class="btn" onclick="startTask(${t.id})" ${currentRun ? "disabled":""}>Ø¨Ø¯Ø¡</button>`
      : `<span class="pill"><span class="dot ${st.cls}"></span>${st.text}</span>`;

    return `
      <div class="task">
        <div class="left">
          <span class="dot ${st.cls}"></span>
          <div class="meta">
            <b>${t.title}</b>
            <div class="small">Ù…ÙƒØ§ÙØ£Ø©: ${t.reward_points} Ù†Ù‚Ø·Ø© â€¢ ØªØ±ØªÙŠØ¨ ${t.order_index}</div>
          </div>
        </div>
        <div>${btn}</div>
      </div>
    `;
  }

  // Ring math
  const ring = document.getElementById("ringProg");
  const R = 46;
  const C = 2 * Math.PI * R; // circumference
  ring.style.strokeDasharray = String(C);
  ring.style.strokeDashoffset = String(C);

  function setRingProgress(pct){
    pct = Math.max(0, Math.min(1, pct));
    const off = C * (1 - pct);
    ring.style.strokeDashoffset = String(off);
  }

  // Overlay controls
  const overlay = document.getElementById("overlay");
  const secEl = document.getElementById("sec");
  const hintEl = document.getElementById("hint");
  const runTitle = document.getElementById("runTitle");
  const flash = document.getElementById("flash");
  const checkWrap = document.getElementById("checkWrap");

  // Particles (stardust while waiting)
  let particles = [];
  let confetti = [];
  let raf = null;
  let runningFX = false;

  function rand(min,max){ return min + Math.random()*(max-min); }

  function spawnStardust(){
    // spawn near center
    const cx = window.innerWidth/2;
    const cy = window.innerHeight/2;
    for(let i=0;i<10;i++){
      particles.push({
        x: cx + rand(-30,30),
        y: cy + rand(-30,30),
        vx: rand(-0.7,0.7),
        vy: rand(-1.2,0.2),
        a: rand(0.25,0.85),
        r: rand(1,2.2),
        life: rand(28,60),
        hue: Math.random()<.5 ? 205 : 265 // sky/purple
      });
    }
  }

  function spawnConfetti(){
    const cx = window.innerWidth/2;
    const cy = window.innerHeight/2;
    for(let i=0;i<160;i++){
      confetti.push({
        x: cx + rand(-12,12),
        y: cy + rand(-12,12),
        vx: rand(-6,6),
        vy: rand(-9,-2),
        g: rand(0.20,0.35),
        a: rand(0.7,1),
        w: rand(3,6),
        h: rand(6,12),
        rot: rand(0,Math.PI),
        vr: rand(-0.25,0.25),
        hue: rand(0,360),
        life: rand(55,90)
      });
    }
  }

  function fxLoop(){
    if(!runningFX) return;
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    // stardust
    if(particles.length<140) spawnStardust();

    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.life -= 1;
      p.a *= 0.985;

      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 95%, 75%, ${p.a})`;
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();

      if(p.life<=0 || p.a<0.05) particles.splice(i,1);
    }

    // confetti
    for(let i=confetti.length-1;i>=0;i--){
      const c = confetti[i];
      c.vy += c.g;
      c.x += c.vx;
      c.y += c.vy;
      c.rot += c.vr;
      c.life -= 1;
      c.a *= 0.985;

      ctx.save();
      ctx.translate(c.x, c.y);
      ctx.rotate(c.rot);
      ctx.fillStyle = `hsla(${c.hue}, 95%, 65%, ${c.a})`;
      ctx.fillRect(-c.w/2, -c.h/2, c.w, c.h);
      ctx.restore();

      if(c.life<=0 || c.y>window.innerHeight+50 || c.a<0.05) confetti.splice(i,1);
    }

    raf = requestAnimationFrame(fxLoop);
  }

  function startFX(){
    particles = [];
    confetti = [];
    runningFX = true;
    fx.classList.add("show");
    if(!raf) fxLoop();
  }

  function stopFX(){
    runningFX = false;
    fx.classList.remove("show");
    if(raf){
      cancelAnimationFrame(raf);
      raf = null;
    }
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    particles = [];
    confetti = [];
  }

  function showOverlay(title, seconds){
    runTitle.textContent = title || "Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°";
    waitTotal = Number(seconds || 10);
    waitLeft = waitTotal;
    secEl.textContent = waitLeft;
    hintEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒÙŠØ©â€¦";
    setRingProgress(0);

    checkWrap.classList.remove("show");
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    startFX();
  }

  function hideOverlay(){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    stopFX();
  }

  function completeFX(){
    // flash + confetti + checkmark
    flash.classList.remove("go");
    void flash.offsetWidth;
    flash.classList.add("go");

    spawnConfetti();
    checkWrap.classList.add("show");
    hintEl.textContent = "ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…";
  }

  // ---- Load tasks list
  async function load(){
    const r = await api("/api/tasks");
    const box = document.getElementById("tasks");
    box.innerHTML = (r.rows||[]).map(renderTask).join("");

    const av = (r.rows||[]).find(x=>x.status==="available");
    if(av && av.wait_seconds){
      document.getElementById("waitPill").textContent = `â±ï¸ Ø§Ù†ØªØ¸Ø§Ø± ${av.wait_seconds} Ø«ÙˆØ§Ù†ÙŠ Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø©`;
    }
  }

  // IMPORTANT: keep server as-is:
  // /api/tasks/start and /api/tasks/finish
  async function startTask(taskId){
    try{
      const r = await api("/api/tasks/start","POST",{});
      currentRun = r.run_token;

      const rows = await api("/api/tasks");
      const av = (rows.rows||[]).find(x=>x.status==="available") || {};
      const title = av.title || "Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©";

      showOverlay(title, r.wait_seconds);

      // timer
      waitTotal = Number(r.wait_seconds || 10);
      waitLeft = waitTotal;
      secEl.textContent = waitLeft;
      setRingProgress(0);

      timer = setInterval(()=>{
        waitLeft--;
        if(waitLeft<=0){
          clearInterval(timer);
          secEl.textContent = "0";
          setRingProgress(1);
          finishTask(); // will trigger completion animation
        }else{
          secEl.textContent = waitLeft;
          const pct = (waitTotal - waitLeft) / waitTotal;
          setRingProgress(pct);
        }
      },1000);

      toast(`Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©â€¦`);

    }catch(e){
      toast(e.message || "ÙˆÙ‚Ø¹ Ø®Ø·Ø£");
      currentRun = null;
      hideOverlay();
    }
  }

  async function finishTask(){
    try{
      await api("/api/tasks/finish","POST",{ run_token: currentRun });

      // completion cinematic
      completeFX();

      // small delay for satisfaction, then close and refresh list
      setTimeout(async ()=>{
        currentRun = null;
        hideOverlay();
        await load();
        toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© âœ…");
      }, 850);

    }catch(e){
      toast(e.message || "ÙˆÙ‚Ø¹ Ø®Ø·Ø£");
      currentRun = null;
      hideOverlay();
      await load();
    }
  }

  // âœ… Active nav highlight
(function setActiveNav(){
  const p = location.pathname;
  const home = document.getElementById("navHome");
  const tasks = document.getElementById("navTasks");
  const profile = document.getElementById("navProfile");

  if(home && (p==="/home" || p==="/")) home.classList.add("active");
  if(tasks && p==="/tasks") tasks.classList.add("active");
  if(profile && p==="/profile") profile.classList.add("active");
})();

  // Start page
  load().catch(e=>toast(e.message));
</script>
</body>
</html>